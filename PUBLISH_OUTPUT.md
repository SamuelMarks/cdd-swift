# Publishing Generated Client Libraries

This guide explains how to automate the generation, updating, and publishing of a Swift client library generated by `cdd-swift` from an OpenAPI specification.

## 1. Automation Setup (GitHub Actions Cron Job)

To ensure your generated Swift client library remains synchronized with the backend server's live OpenAPI specification, you should run a scheduled automation workflow.

Create a GitHub Actions workflow in your client library repository (e.g., `.github/workflows/update-client.yml`):

```yaml
name: Sync Swift Client with OpenAPI

on:
  schedule:
    # Run automatically every day at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual triggers via GitHub UI

jobs:
  update-client:
    runs-on: macos-latest
    steps:
      - name: Checkout Client Repository
        uses: actions/checkout@v4

      - name: Fetch Latest OpenAPI Spec
        run: |
          curl -s https://api.yourserver.com/openapi.json -o openapi.json

      - name: Run cdd-swift to Generate Code
        run: |
          # Fetch the generator tool and execute it. 
          # Adjust this command depending on how you install cdd-swift (e.g., via Mint, raw Swift run, or pre-built binary).
          swift run --package-path path/to/cdd-swift cdd-swift-cli generate --input openapi.json --output Sources/GeneratedClient

      - name: Check for Code Changes
        id: git-check
        run: |
          git diff --exit-code || echo "changes=true" >> $GITHUB_OUTPUT

      - name: Commit and Push Changes
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore: auto-update generated swift client from latest openapi spec"
          git push

      # Optional: Automatically tag a new patch version if changes were detected
      - name: Tag new version
        if: steps.git-check.outputs.changes == 'true'
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 || echo "0.0.0")
          # Simple auto-increment for patch versions (Consider semantic-release for advanced usage)
          NEW_TAG=$(echo $LATEST_TAG | awk -F. -v OFS=. '{$NF += 1 ; print}')
          git tag $NEW_TAG
          git push origin $NEW_TAG
```

## 2. Distributing the Generated Client Library

Once the client library is generated and pushed to its own Git repository (or a designated directory configured as a Swift Package), it is ready for consumption.

### Swift Package Manager (SPM) Distribution

Ensure the root of the generated client contains a valid `Package.swift`:

```swift
// swift-tools-version: 5.9
import PackageDescription

let package = Package(
    name: "MyGeneratedAPIClient",
    platforms: [
        .macOS(.v10_15), .iOS(.v13)
    ],
    products: [
        .library(
            name: "MyGeneratedAPIClient", 
            targets: ["MyGeneratedAPIClient"]
        ),
    ],
    dependencies: [
        // Any dependencies the generated cdd-swift code relies on
    ],
    targets: [
        .target(
            name: "MyGeneratedAPIClient", 
            dependencies: []
        ),
    ]
)
```

Consumers can now include your generated client in their Xcode projects or Swift Packages by referencing the Git URL:

```swift
dependencies: [
    .package(url: "https://github.com/your-org/my-generated-api-client.git", from: "1.0.0")
]
```

### 3. Documentation for the Client Library

`cdd-swift` should embed standard Swift documentation block comments (`///`) into the generated source code based on the descriptions in the OpenAPI spec.

You can publish the generated client's documentation exactly the same way as described in `PUBLISH.md`, using DocC and GitHub Pages. This ensures that the downstream developers using your client have an up-to-date visual API reference.